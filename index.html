<!DOCTYPE html>
<!-- This HTML source code is placed in the public domain -->
<html manifest="manifest">
 <head>
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style"
    content="black-translucent" />
  <link rel="apple-touch-icon-precomposed" href="touch-icon.png" />
  <link rel="shortcut icon" href="touch-icon.png" />
  <style type="text/css">
body {
    font-size: 300%;
    font-family: sans-serif;
    text-align: center;
}
#ui {
    margin-top: 40px;
}
#average {
    font-size: 200%;
}
#days {
    -webkit-appearance: none;
    font-size: inherit;
}
#kilos, #grams {
    -webkit-appearance: none;
    font-size: inherit;
    margin-top: .5em;
}
#history {
    font-size: 50%;
    margin-top: .5em;
}
#log {
    font-family: monospace;
    font-size: 30%;
    opacity: 0;
    text-align: left;
}
  </style>
  <title>Weight</title>
 </head>
 <body>
  <div id="ui">
   <div id="average">
   </div>
   <div>
    <select id="days"></select>
   </div>
   <div>
    <select id="kilos"></select>.<select id="grams"></select>
   </div>
   <div id="history">
   </div>
   <div id="log">
<hr>
Log start...
<br>
<br>
   </div>
  </div>
  <script type="text/javascript">
(function () {
'use strict';
var qs = function (q) {return document.querySelector(q);},
    qsa = function (q) {
        return Array.prototype.slice.call(document.querySelectorAll(q));
    },
    logContents = qs('#log').innerHTML,
    isLogVisible,
    log,
    toggleVisibility,
    day,
    onWeightChange,
    onDayChange,
    MAX_WEIGHT = 75,
    MIN_WEIGHT = 50,
    theDays = ["Today", "Yesterday", "Today - 2", "Today - 3"],
    state,
    current = 0,
    dummy;

isLogVisible = function () {
    return qs('#log').style.opacity === '1';
};

toggleVisibility = function (e) {
    e.style.opacity  = isLogVisible() ? '' : '1';
};

log = function (m) {
    logContents = '<hr>' + m + logContents;
    if (!isLogVisible()) {
        return;
    }
    qs('#log').innerHTML = '<hr>' + m + qs('#log').innerHTML;
    document.body.scrollTop = document.documentElement.scrollTop = 0;
};

day = function () {
    return Math.floor(new Date().getTime() / 1000 / 60 / 60 / 24);
};

onWeightChange = function () {
    var today = day(),
        av,
        i;

    while (state.day < today) {
        state.weights.pop();
        state.weights.unshift(state.weights[0]);
        state.day++;
        current = 0;
    }
    state.weights[current] =
        parseFloat(qs('#kilos').value + '.' + qs('#grams').value);
    localStorage.state = JSON.stringify(state);
    av = 0;
    for (i = 0; i < state.weights.length; i++) {
        av += state.weights[i];
    }
    av /= state.weights.length;
    av = String(Math.floor(av * 10 + 0.5));
    av = av.substr(0, av.length - 1) + '.' + av.substr(av.length - 1, 1);
    qs('#average').innerHTML = av;
    qs('#history').innerHTML = state.weights.join(' ');
    log(today + ' ' + current + ' ' + av + ' ' + localStorage.state);
};

onDayChange = function () {
    var w;
    current = qs('#days').selectedIndex;
    w = state.weights[current];
    qs('#kilos').value = Math.floor(w);
    qs('#grams').value = Math.floor(w * 10 % 10);

    log(current + ' ' + theDays[current]);
};

(function () {
    var max = MAX_WEIGHT - 0.1,
        list,
        i;
    state = localStorage.state;
    if (state) {
        state = JSON.parse(state);
    }
    else {
        state = {day: day(), weights: [max, max, max, max]};
    }

    list = [];
    for (i = MIN_WEIGHT; i < MAX_WEIGHT; i++) {
        list.push(String(i));
    }
    qs('#kilos').innerHTML =
        '<option>' + list.join('</option><option>') + '</option>';
    qs('#kilos').addEventListener('change', onWeightChange, false);

    list = [];
    for (i = 0; i < 10; i++) {
        list.push(String(i));
    }
    qs('#grams').innerHTML =
        '<option>' + list.join('</option><option>') + '</option>';
    qs('#grams').addEventListener('change', onWeightChange, false);

    qs('#days').innerHTML =
        '<option>' + theDays.join('</option><option>') + '</option>';
    qs('#days').addEventListener('change', onDayChange, false);
    qs('#days').addEventListener('blur', function () {console.log('blur');}, false);

    qs('#log').addEventListener('dblclick', function () {
        toggleVisibility(this);
    }, false);
    qs('#log').addEventListener('gesturestart', function () {
        toggleVisibility(this);},
    false);

    onDayChange();
    onWeightChange();
}());

}());
  </script>
 </body>
</html>
